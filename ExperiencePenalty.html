<!DOCTYPE html>
<html lang="en">
<head>
    <title>Experience Penalty - ExileKit</title>

    <!--
        placeholder for version 2.0

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
    -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link rel="stylesheet" href="Common.css">
    <style>
        input
        {
            font-size: 300%;
            text-align: center;
        }

        thead
        {
            font-size: 120%;
        }

        .section
        {
            border: 2px dashed;
            border-radius: 10px;
            margin: 10px;
            padding: 10px;
        }

        .section-label
        {
            text-align: right;
            font-size: 150%;
            font-weight: bold;
        }

        .notable-value
        {
            font-size: 150%;
            font-weight: bold;
        }

        .significant-value
        {
            font-size: 200%;
            font-weight: bold;
        }

        .penalty_table.table, .penalty_table.td, .penalty_table.tr
        {
            border-collapse: collapse;
            border-color: gray;
        }
    </style>
</head>
<body>
    <div>
        <a href="/"><img class="nav-bar-logo-link" src="assets/BasicDisguiseKit.png" /></a>
        <a href="/" class="nav-bar-logo">ExileKit</a>
        <span style="vertical-align:middle;" class="nav-bar-path">&nbsp;/ ExperiencePenalty.html</span>
    </div>

    <div class="pagebody">
        <h1>Experience Penalty</h1>

        <div style="display:flex; justify-content:center;">
            <table border="0">
                <tr>
                    <td><div class="section-label" style="color:orange;">Input</div></td>
                    <td align="center" colspan="3">
                        <div class="section" style="border-color:orange;">
                            <table>
                                <tr>
                                    <td>
                                        <div class="notable-value" style="text-align: right;">Player<br />Level</div>
                                    </td>
                                    <td>
                                        <input id="playerLevel" value="95" size="2" min="1" max="99" type="number" />
                                    </td>
                                    <td>
                                        <input id="areaLevel" value="83" size="2" min="1" max="99" type="number" />
                                    </td>
                                    <td>
                                        <div class="notable-value" style="text-align: left;">Area<br />Level</div>
                                    </td>

                                </tr>
                            </table>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td><div class="section-label" style="color:cyan;">PL 95-99<br />Adjustment</div></td>
                    <td align="center">
                        <div style="border:2px dashed cyan; border-radius:10px; margin:10px; padding:10px;">
                            <h3><a href="https://www.poewiki.net/wiki/Experience">PoEWiki</a></h3>
                            <table class="penalty_table" border="1">
                                <tr><td>95</td><td>1.0 / 1.0650</td></tr>
                                <tr><td>96</td><td>1.0 / 1.1150</td></tr>
                                <tr><td>97</td><td>1.0 / 1.1870</td></tr>
                                <tr><td>98</td><td>1.0 / 1.2825</td></tr>
                                <tr><td>99</td><td>1.0 / 1.4000</td></tr>
                            </table>
                        </div>
                    </td>
                    <td align="center">
                        <div style="border:2px dashed cyan; border-radius:10px; margin:10px; padding:10px;">
                            <h3><a href="https://www.i-volve.net/jol/poe_xpdrop_en.php">i-volve.net</a></h3>
                            <table border="1">
                                <tr><td>95</td><td>0.9350</td></tr>
                                <tr><td>96</td><td>0.8850</td></tr>
                                <tr><td>97</td><td>0.8125</td></tr>
                                <tr><td>98</td><td>0.7175</td></tr>
                                <tr><td>99</td><td>0.6000</td></tr>
                            </table>
                        </div>
                    </td>
                    <td align="center">
                        <div style="border:2px dashed cyan; border-radius:10px; margin:10px; padding:10px;">
                            <h3><a href="https://www.youtube.com/watch?v=ZRqZHH4pskI">Fyregrass</a></h3>
                            <table border="1">
                                <tr><td>95</td><td>0.9957 * 0.9390</td></tr>
                                <tr><td>96</td><td>0.9867 * 0.8969</td></tr>
                                <tr><td>97</td><td>0.9644 * 0.8425</td></tr>
                                <tr><td>98</td><td>0.9202 * 0.7797</td></tr>
                                <tr><td>99</td><td>0.8400 * 0.7143</td></tr>
                            </table>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td><div class="section-label" style="color: lime;">XP Penalty</div></td>
                    <td align="center">
                        <div class="section" style="border-color: lime; min-width: 280px;">
                            <div id="penaltyPoEWiki" class="significant-value">0%</div>
                            <div id="penaltyPoEWikiRate">(0% rate)</div>
                            <div id="penaltyPoEWikiExample">a 100xp rhoa gives you 100xp</div>
                        </div>
                    </td>
                    <td align="center">
                        <div class="section" style="border-color: lime; min-width: 280px; ">
                            <div id="penaltyVolve" class="significant-value">0%</div>
                            <div id="penaltyVolveRate">(0% XP rate)</div>
                            <div id="penaltyVolveExample">a 100xp rhoa gives you 100xp</div>
                        </div>
                    </td>
                    <td align="center">
                        <div class="section" style="border-color: lime; min-width: 280px; ">
                            <div id="penaltyFyregrass" class="significant-value">0%</div>
                            <div id="penaltyFyregrassRate">(0% XP rate)</div>
                            <div id="penaltyFyregrassExample">a 100xp rhoa gives you 100xp</div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td><div class="section-label" style="color:brown;">Currency<br/>Penalty</div></td>
                    <td align="center" colspan="3">
                        <div class="section" style="border-color: brown;">
                            <div id="dropPenalty" class="significant-value">20%</div>
                            <div id="dropPenaltyRate">(0% drop rate)</div>
                            <div id="dropPenaltyExample">if that rhoa dropped 100c, you'd get 80c</div>
                        </div>
                    </td>
                </tr>
            </table>

            <div style="border: 2px dashed gray; border-radius: 10px; margin: 10px; padding: 10px;">
                <table border="0">
                    <tr><td align="right">T1</td><td>=</td><td>68</td></tr>
                    <tr><td align="right">T2</td><td>=</td><td>69</td></tr>
                    <tr><td align="right">T3</td><td>=</td><td>70</td></tr>
                    <tr><td align="right">T4</td><td>=</td><td>71</td></tr>
                    <tr><td align="right">T5</td><td>=</td><td>72</td></tr>
                    <tr style="color: yellow;"><td align="right">T6</td><td>=</td><td>73</td></tr>
                    <tr style="color: yellow;"><td align="right">T7</td><td>=</td><td>74</td></tr>
                    <tr style="color: yellow;"><td align="right">T8</td><td>=</td><td>75</td></tr>
                    <tr style="color: yellow;"><td align="right">T9</td><td>=</td><td>76</td></tr>
                    <tr style="color: yellow;"><td align="right">T10</td><td>=</td><td>77</td></tr>
                    <tr style="color: red;"><td align="right">T11</td><td>=</td><td>78</td></tr>
                    <tr style="color: red;"><td align="right">T12</td><td>=</td><td>79</td></tr>
                    <tr style="color: red;"><td align="right">T13</td><td>=</td><td>80</td></tr>
                    <tr style="color: red;"><td align="right">T14</td><td>=</td><td>81</td></tr>
                    <tr style="color: red;"><td align="right">T15</td><td>=</td><td>82</td></tr>
                    <tr style="color: red;"><td align="right">T16</td><td>=</td><td>83</td></tr>
                </table>
            </div>
        </div>

        <script type="text/javascript">
            const playerLevelElement = document.getElementById("playerLevel");
            const areaLevelElement = document.getElementById("areaLevel");

            playerLevelElement.addEventListener("change", (event) => { refresh_calculation(); });
            areaLevelElement.addEventListener("change", (event) => { refresh_calculation(); });

            refresh_calculation();
            function refresh_calculation()
            {
                const penalty_poewiki = [
                    1.0 / 1.0650,
                    1.0 / 1.1150,
                    1.0 / 1.1870,
                    1.0 / 1.2825,
                    1.0 / 1.4000];
                const penalty_volve = [
                    0.9350,
                    0.8850,
                    0.8125,
                    0.7175,
                    0.6000];
                const penalty_fyregrass = [
                    0.9957 * 0.9390,
                    0.9867 * 0.8969,
                    0.9644 * 0.8425,
                    0.9202 * 0.7797,
                    0.8400 * 0.7143];

                // confined [1,99] and non-NaN
                const playerLevel = Math.max(1, Math.min(99, parseInt(playerLevelElement.value) || 1));
                const areaLevel = Math.max(1, Math.min(99, parseInt(areaLevelElement.value) || 1));

                calculate_xp_and_set_dom(
                    playerLevel, areaLevel, penalty_poewiki,
                    document.getElementById("penaltyPoEWiki"),
                    document.getElementById("penaltyPoEWikiRate"),
                    document.getElementById("penaltyPoEWikiExample"));

                calculate_xp_and_set_dom(
                    playerLevel, areaLevel, penalty_volve,
                    document.getElementById("penaltyVolve"),
                    document.getElementById("penaltyVolveRate"),
                    document.getElementById("penaltyVolveExample"));

                calculate_xp_and_set_dom(
                    playerLevel, areaLevel, penalty_fyregrass,
                    document.getElementById("penaltyFyregrass"),
                    document.getElementById("penaltyFyregrassRate"),
                    document.getElementById("penaltyFyregrassExample"));

                calculate_droprate_and_set_dom(
                    playerLevel, areaLevel,
                    document.getElementById("dropPenalty"),
                    document.getElementById("dropPenaltyRate"),
                    document.getElementById("dropPenaltyExample"));
            }

            function calculate_droprate_and_set_dom(playerLevel, areaLevel, element, elementrate, elementexample)
            {
                const dropMultiplier = calculate_droprate_actual(playerLevel, areaLevel);

                element.innerHTML =
                    (1.0 - dropMultiplier).toLocaleString(undefined, { style: 'percent', minimumFractionDigits: 2 });
                elementrate.innerHTML = "(" + dropMultiplier.toLocaleString(undefined, { style: 'percent', minimumFractionDigits: 2 }) + " drop rate)";
                elementexample.innerHTML = "if that rhoa dropped 100c, you'd get " + parseInt(100 * dropMultiplier) + "c";
            }

            function calculate_droprate_actual(playerLevel, areaLevel)
            {
                const effectivePlayerlevel = playerLevel > 68 ? 68 : playerLevel;
                const effectiveDifference = Math.max(0, effectivePlayerlevel - (areaLevel + 2));
                return 1.0 - 0.025 * effectiveDifference;
            }

            function calculate_xp_and_set_dom(playerLevel, areaLevel, penalty, element, elementrate, elementexample)
            {
                const xpMultiplier = calculate_xp_actual(playerLevel, areaLevel, penalty);

                element.innerHTML =
                    (1.0 - xpMultiplier).toLocaleString(undefined, { style: 'percent', minimumFractionDigits: 2 });
                elementrate.innerHTML = "(" + xpMultiplier.toLocaleString(undefined, { style: 'percent', minimumFractionDigits: 2 }) + " XP rate)";
                elementexample.innerHTML = "a 10000xp rhoa gives you " + parseInt(10000 * xpMultiplier) + "xp";
            }

            function calculate_xp_actual(playerLevel, areaLevel, penalty)
            {
                const effectiveMonsterLevel = calculate_effective_monster_level(areaLevel);
                const safeZone = 3 + Math.floor(playerLevel / 16);
                const effectiveDifference = Math.max(0, Math.abs(playerLevel - effectiveMonsterLevel) - safeZone);

                let xpMultiplier = Math.pow((playerLevel + 5) / (playerLevel + 5 + Math.pow(effectiveDifference, 2.5)), 1.5);
                if (playerLevel >= 95) {
                    xpMultiplier *= (1.0 / (1.0 + 0.1 * (playerLevel - 94.0)));
                    xpMultiplier *= penalty[playerLevel - 95];
                }
                xpMultiplier = Math.max(0.01, xpMultiplier);

                return xpMultiplier;
            }

            function calculate_effective_monster_level(areaLevel)
            {
                if (areaLevel > 70) {
                    return -0.03 * areaLevel * areaLevel + 5.17 * areaLevel - 144.90;
                }
                else {
                    return areaLevel;
                }
            }
        </script>

        <!--
            placeholder for version 2.0

            <div style="border:2px dashed purple; margin:10px;">
                <h2>Explanation of Math</h2>
                <div id="some_katex_thing" />
                <script>
                    katex.render("c = \\pm\\sqrt{a^2 + b^2}", some_katex_thing);
                </script>
                draw rest of owl
            </div>
        -->
    </div>
</body>
</html>